import requests
from rich.console import Console
from aura.core.stealth import StealthEngine, AuraSession
from aura.core.notifier import CommLink

console = Console()
stealth = StealthEngine()
session = AuraSession(stealth)
comm_link = CommLink()

class AuraExploiter:
    """Active weaponization engine for Aura."""
    
    def __init__(self):
        self.payloads = [
            ".env", "config.php", ".git/config", "backup.sql", 
            "admin/", "phpmyadmin/", ".aws/credentials"
        ]

    async def fuzz_directories(self, url):
        """Fuzzes a web target for sensitive files/directories with network throttling."""
        if not url.startswith("http"):
            url = f"http://{url}"
            
        console.print(f"[bold red][!] Target acquired: {url}[/bold red]")
        console.print(f"[yellow][*] Starting active directory fuzzing...[/yellow]")
        
        found = []
        for payload in self.payloads:
            full_url = f"{url.rstrip('/')}/{payload}"
            try:
                # Using throttled AuraSession for system stability
                response = await session.get(full_url, timeout=5)
                if response.status_code == 200:
                    console.print(f"[bold green][!!!] EXPLOIT SUCCESS: Found sensitive path: {full_url} [Code: 200][/bold green]")
                    comm_link.send_telegram_alert(f"Active Exploit Path Found!\nURL: `{full_url}`")
                    found.append(full_url)
                elif response.status_code == 403:
                    console.print(f"[yellow][?] ACCESS DENIED: Path exists but is protected: {full_url} [Code: 403][/yellow]")
            except Exception:
                continue
        
        return found

    async def pwn_target(self, target_id, target_value):
        """Main entry point for active exploitation."""
        console.print(f"\n[bold magenta]PREDATOR MODE ACTIVATED FOR TARGET {target_id}: {target_value}[/bold magenta]")
        # For now, we focus on web-based fuzzing
        return await self.fuzz_directories(target_value)
